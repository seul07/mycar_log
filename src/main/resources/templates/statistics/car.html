<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{statistics.title}">Statistics</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <main class="container">
        <div class="page-header">
            <a th:href="@{/statistics}" class="back-btn">&larr;</a>
            <h1>
                <span th:text="${car.manufacturer}">Manufacturer</span>
                <span th:text="${car.modelName}">Model</span>
            </h1>
        </div>

        <!-- Period Selection -->
        <div class="card period-selector">
            <form id="periodForm" method="get" th:action="@{'/statistics/car/' + ${carId}}">
                <div class="form-row">
                    <div class="form-group">
                        <label th:for="startDate" th:text="#{statistics.start.date}">Start Date</label>
                        <input type="date" id="startDate" name="startDate" class="form-control"
                               th:value="${#temporals.format(startDate, 'yyyy-MM-dd')}">
                    </div>
                    <div class="form-group">
                        <label th:for="endDate" th:text="#{statistics.end.date}">End Date</label>
                        <input type="date" id="endDate" name="endDate" class="form-control"
                               th:value="${#temporals.format(endDate, 'yyyy-MM-dd')}">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" th:text="#{statistics.apply}">Apply</button>
            </form>
        </div>

        <!-- Total -->
        <div class="card stats-total">
            <h3 th:text="#{statistics.total}">Total Expenses</h3>
            <div class="total-amount" th:text="${#numbers.formatInteger(totalAmount, 1, 'COMMA')} + ' 원'">0 원</div>
        </div>

        <!-- Charts -->
        <div class="card" th:if="${totalAmount > 0}">
            <h3 th:text="#{statistics.by.category}">Expenses by Category</h3>

            <!-- Bar Chart -->
            <div class="chart-container">
                <h4 th:text="#{statistics.chart.bar}">Bar Chart</h4>
                <canvas id="barChart"></canvas>
            </div>

            <!-- Donut Chart -->
            <div class="chart-container">
                <h4 th:text="#{statistics.chart.donut}">Donut Chart</h4>
                <canvas id="donutChart"></canvas>
            </div>
        </div>

        <div class="empty-state" th:if="${totalAmount == 0}">
            <p th:text="#{statistics.no.data}">No expense data for this period</p>
        </div>
    </main>

    <nav class="bottom-nav" th:replace="~{fragments/nav :: nav}"></nav>

    <script th:inline="javascript">
        const categoryTotals = /*[[${categoryTotals}]]*/ {};
        const categories = /*[[${categories}]]*/ [];
        const totalAmount = /*[[${totalAmount}]]*/ 0;

        // Category labels mapping
        const categoryLabels = {
            'MILEAGE': /*[[#{expense.category.mileage}]]*/ 'Mileage',
            'FUEL': /*[[#{expense.category.fuel}]]*/ 'Fuel',
            'MAINTENANCE': /*[[#{expense.category.maintenance}]]*/ 'Maintenance',
            'TAX': /*[[#{expense.category.tax}]]*/ 'Tax',
            'INSURANCE': /*[[#{expense.category.insurance}]]*/ 'Insurance',
            'PARKING': /*[[#{expense.category.parking}]]*/ 'Parking',
            'CAR_WASH': /*[[#{expense.category.carwash}]]*/ 'Car Wash',
            'OTHER': /*[[#{expense.category.other}]]*/ 'Other'
        };

        // Category colors
        const categoryColors = {
            'MILEAGE': '#4CAF50',
            'FUEL': '#FF9800',
            'MAINTENANCE': '#2196F3',
            'TAX': '#9C27B0',
            'INSURANCE': '#00BCD4',
            'PARKING': '#795548',
            'CAR_WASH': '#03A9F4',
            'OTHER': '#9E9E9E'
        };

        if (totalAmount > 0) {
            // Prepare data
            const labels = [];
            const data = [];
            const colors = [];

            for (const category of categories) {
                const categoryName = category.name || category;
                const amount = categoryTotals[categoryName] || 0;
                if (amount > 0) {
                    labels.push(categoryLabels[categoryName] || categoryName);
                    data.push(amount);
                    colors.push(categoryColors[categoryName] || '#9E9E9E');
                }
            }

            // Bar Chart
            const barCtx = document.getElementById('barChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: categoryLabels['FUEL'],
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' 원';
                                }
                            }
                        }
                    }
                }
            });

            // Donut Chart
            const donutCtx = document.getElementById('donutChart').getContext('2d');
            new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = ((value / totalAmount) * 100).toFixed(1);
                                    return context.label + ': ' + value.toLocaleString() + ' 원 (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
    <script th:src="@{/js/app.js}"></script>
</body>
</html>
